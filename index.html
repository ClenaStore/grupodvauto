<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Parcelas - Grupo DV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
  <style>
    body{margin:0;font-family:Inter,system-ui;background:#0b1220;color:#e5f0ff}
    header{background:#0f172a;padding:14px;font-weight:800;font-size:18px}
    .controls{padding:14px;display:flex;gap:10px;flex-wrap:wrap}
    select,input{background:#0b1528;border:1px solid #22314b;color:#e5f0ff;padding:10px;border-radius:8px}
    .container{padding:14px}
    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{padding:10px;border-bottom:1px solid #22314b;text-align:left}
    th{background:#101a2f}
    tr:hover{background:#16213b}
    .pill{padding:4px 8px;border-radius:6px;font-size:12px;font-weight:700}
    .pill.pendente{background:#1e3a8a;color:#93c5fd}
    .pill.aprovado{background:#065f46;color:#6ee7b7}
    .pill.negado{background:#7f1d1d;color:#fca5a5}
  </style>
</head>
<body>
<header>Parcelas - Grupo DV</header>

<div class="controls">
  <input type="text" id="filtroPeriodo" placeholder="Selecione período">
  <select id="filtroEmpresa"></select>
  <select id="filtroStatus">
    <option value="Todos">Todos</option>
    <option value="Pendente">Pendentes</option>
    <option value="Aprovado">Pagos</option>
    <option value="Negado">Cancelados</option>
  </select>
</div>

<div class="container">
  <table>
    <thead>
      <tr>
        <th>Fornecedor</th>
        <th>Empresa</th>
        <th>Vencimento</th>
        <th>Valor</th>
        <th>Meio</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="tabelaParcelas"></tbody>
  </table>
</div>

<script>
const API_URL="/api/f360";
const EMPRESAS=["MERCATTO DELÍCIA","VILLA GOURMET","PADARIA DELÍCIA","M.KIDS","DELÍCIA GOURMET"];
let periodoInicio=null,periodoFim=null,parcelasCache=[];

const BRL=n=>(isNaN(n)?0:n).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const iso=d=>d?new Date(d).toISOString().slice(0,10):"";

function mapearParcelas(parcelas){
  return parcelas.map(p=>({
    fornecedor:p.DadosDoTitulo?.ClienteFornecedor?.Nome||"—",
    empresa:p.DadosDoTitulo?.Empresa?.Nome||"—",
    vencimento:p.Vencimento,
    valor:p.ValorBruto,
    meio:p.MeioDePagamento||"Outros",
    status:p.Status.includes("Aberto")?"Pendente":p.Status.includes("Pago")?"Aprovado":"Negado"
  }));
}

function renderTabela(){
  const corpo=document.getElementById("tabelaParcelas");
  corpo.innerHTML="";
  const filtroStatus=document.getElementById("filtroStatus").value;
  const filtroEmpresa=document.getElementById("filtroEmpresa").value;

  parcelasCache
    .filter(p=>(filtroStatus==="Todos"||p.status===filtroStatus))
    .filter(p=>(filtroEmpresa==="Todos"||p.empresa===filtroEmpresa))
    .forEach(p=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${p.fornecedor}</td>
        <td>${p.empresa}</td>
        <td>${p.vencimento}</td>
        <td>${BRL(p.valor)}</td>
        <td>${p.meio}</td>
        <td><span class="pill ${p.status.toLowerCase()}">${p.status}</span></td>`;
      corpo.appendChild(tr);
    });
}

async function fetchParcelas(){
  const empresa=document.getElementById("filtroEmpresa").value;
  const inicio=periodoInicio||iso(new Date());
  const fim=periodoFim||iso(new Date());
  try{
    const r=await fetch(`${API_URL}?empresa=${encodeURIComponent(empresa)}&inicio=${inicio}&fim=${fim}`);
    const d=await r.json();
    parcelasCache=mapearParcelas(d.Result?.Parcelas||[]);
    renderTabela();
  }catch(e){console.error(e)}
}

// inicialização
(function boot(){
  flatpickr("#filtroPeriodo",{mode:"range",dateFormat:"d/m/Y",locale:"pt",
    defaultDate:[new Date(),new Date()],
    onClose:sel=>{if(sel.length===2){periodoInicio=iso(sel[0]);periodoFim=iso(sel[1]);fetchParcelas();}}
  });
  const sel=document.getElementById("filtroEmpresa");
  sel.innerHTML=`<option value="Todos">Todas</option>`+EMPRESAS.map(e=>`<option value="${e}">${e}</option>`).join("");
  sel.onchange=fetchParcelas;
  document.getElementById("filtroStatus").onchange=renderTabela;
  fetchParcelas();
})();
</script>
</body>
</html>
