<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Aprova√ß√£o de CAP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
<style>
/* üîπ Mantive todo seu CSS igual */
:root{--bg:#0b1220;--card:#0f172a;--ink:#e5f0ff;--muted:#a8b3c7;--line:#243043;
--teal:#06b6d4;--blue:#4f46e5;--green:#16a34a;--red:#ef4444;--amber:#f59e0b;}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink);font-size:15px}
/* ... (restante do seu CSS exatamente igual) ... */
</style>
</head>
<body>
<header>
  <h1>CAP - Grupo DV</h1>
  <div class="controls">
    <div class="row-filtros">
      <select id="filtroStatus">
        <option value="Pendente" selected>Pendentes</option>
        <option value="Aprovado">Aprovados</option>
        <option value="Negado">Negados</option>
        <option value="Todos">Todos</option>
      </select>
      <select id="filtroMeio">
        <option value="Todos" selected>Todos</option>
        <option value="Pix">Pix</option>
        <option value="Cart√£o">Cart√£o</option>
        <option value="Boleto">Boleto</option>
        <option value="Outros">Outros</option>
      </select>
    </div>
    <div class="row-linha">
      <input type="text" id="filtroPeriodo" placeholder="Selecione per√≠odo" />
      <div style="position:relative;flex:1">
        <button class="btn icon" id="btnEmpresas"><span id="empresaSelecionada">MERCATTO DEL√çCIA</span> ‚ñº</button>
        <div id="menuEmpresas" class="menu"></div>
      </div>
    </div>
  </div>
</header>

<div id="overlay"><div class="spinner"></div></div>

<div class="container">
  <div id="statusCards" class="status-cards"></div>
  <div class="mods-card">
    <div style="font-weight:800;margin-bottom:8px;font-size:16px">Modalidades</div>
    <div id="mods" class="mods"></div>
  </div>
  <div class="list-head">
    <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
      <input id="master" type="checkbox" />
      <b>Selecionar todos</b>
    </label>
    <div id="contagem" style="color:var(--muted);font-size:14px">0 itens</div>
  </div>
  <div id="lista" class="lista"></div>
</div>

<div class="footer">
  <div id="bubble" class="bubble" style="display:none">Total selecionado: R$ 0,00</div>
  <button id="btnMassa" class="btn-massa" style="display:none"><span>Aprovar selecionados</span><div class="spinner-btn"></div></button>
</div>

<!-- modal observa√ß√£o -->
<div id="modalObs" class="modal">
  <div class="box">
    <button class="close" onclick="fecharObs()">Fechar</button>
    <h3>Observa√ß√£o</h3>
    <textarea id="textoObs" placeholder="Digite a observa√ß√£o..."></textarea>
    <button class="btn" style="margin-top:10px" onclick="salvarObs()"><span>Salvar</span><div class="spinner-btn"></div></button>
  </div>
</div>

<script>
const endpointTitulos = "/api/f360"; // üîπ backend na Vercel
const EMP_DEFAULT=["MERCATTO DEL√çCIA","VILLA GOURMET","PADARIA DEL√çCIA","M.KIDS","DEL√çCIA GOURMET"];
let TITULOS={},SELEC=[],obsContext={};
let periodoInicio=null, periodoFim=null;

const $=id=>document.getElementById(id);
const BRL=n=>(isNaN(n)?0:n).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const iso=d=>{const dt=new Date(d);dt.setMinutes(dt.getMinutes()-dt.getTimezoneOffset());return dt.toISOString().slice(0,10);};
const ID=(emp,linha)=>`${emp.replace(/\s+/g,'_')}__${linha}`;

// üîπ Normaliza meio de pagamento
function normalizeMeio(meio){
  meio=(meio||"Outros").toLowerCase();
  if(meio.includes("pix"))return "Pix";
  if(meio.includes("cart"))return "Cart√£o";
  if(meio.includes("bol"))return "Boleto";
  return "Outros";
}

// üîπ Busca dados da API F360 (via Vercel)
async function fetchEmpresa(emp,inicio,fim,tipo="Despesa"){
  try{
    const url=`${endpointTitulos}?empresa=${encodeURIComponent(emp)}&inicio=${inicio}&fim=${fim}&tipo=${tipo}`;
    const r=await fetch(url);
    const d=await r.json();
    const data=(d.Result?.Parcelas||[]).map((p,i)=>({
      linha:i+1,
      fornecedor:p.DadosDoTitulo?.ClienteFornecedor?.Nome || "‚Äî",
      vencimento:p.Vencimento,
      meio_pagamento:p.MeioDePagamento,
      valor:p.ValorBruto,
      status:p.Cancelada ? "Negado" : (p.Liquidacao ? "Aprovado" : "Pendente"),
      observacao:p.DadosDoTitulo?.Observacao || "",
      historico:p.ConciliadaComExtrato ? "Conciliada com extrato" : "",
    }));
    return data;
  }catch(e){console.error("Erro ao buscar",emp,e);return []}
}

// üîπ Processa e aplica filtros
function processarEmpresa(emp,data,inicio,fim,filtroStatus,filtroMeio){
  const all=data.filter(t=>{
    const d=iso(t.vencimento);
    return (!inicio||d>=inicio)&&(!fim||d<=fim);
  });
  const filtered=all.filter(t=>{
    let st=(t.status||"Pendente");
    const meio=normalizeMeio(t.meio_pagamento);
    const statusOk=filtroStatus==="Todos"?true:(st===filtroStatus);
    const meioOk=filtroMeio==="Todos"?true:(meio===filtroMeio);
    return statusOk&&meioOk;
  });
  TITULOS[emp]={__all:all,__filtered:filtered};
}

// üîπ Carrega e renderiza
async function loadTitulos(empresas,inicio,fim,filtroStatus,filtroMeio){
  TITULOS={};$("overlay").style.display="flex";
  for(const emp of empresas){
    const data=await fetchEmpresa(emp,inicio,fim);
    processarEmpresa(emp,data,inicio,fim,filtroStatus,filtroMeio);
  }
  $("overlay").style.display="none";
  renderLista();
}

// üîπ Renderiza√ß√£o da lista
function renderLista(){
  const lista=$("lista");lista.innerHTML="";SELEC=[];$("master").checked=false;
  let totalItens=0;
  for(const emp of Object.keys(TITULOS)){
    (TITULOS[emp].__filtered||[]).forEach((t)=>{
      totalItens++;
      const valor=Number(t.valor)||0;
      const id=ID(emp,t.linha);
      const st=(t.status||"Pendente");
      const obs=(t.observacao||"");
      const histColuna=(t.historico||"");

      const card=document.createElement("div");
      card.className="titulo";card.dataset.id=id;card.dataset.emp=emp;card.dataset.linha=t.linha;card.dataset.valor=valor;
      card.innerHTML=`
        <div class="ck"><input type="checkbox" onchange="toggleSel(this)" /></div>
        <div class="info">
          <div class="row"><b>${t.fornecedor}</b> ‚Ä¢ ${emp}</div>
          <div class="row">Venc: <b>${iso(t.vencimento).split("-").reverse().join("/")}</b> ‚Ä¢ Meio: <b>${t.meio_pagamento||"Outros"}</b></div>
          <div class="row">Valor: <b>${BRL(valor)}</b></div>
          ${obs?`<div class="row obs" style="color:#60a5fa">Obs: ${obs}</div>`:""}
          ${histColuna?`<div class="row hist">Hist√≥rico F360: ${histColuna}</div>`:""}
        </div>
        <span class="pill" data-status>${st}</span>
        <div class="actions">
          <button class="mini negar" onclick="acaoStatus(this,'Negado')"><span>‚úó Negar</span></button>
          <button class="mini aprovar" onclick="acaoStatus(this,'Aprovado')"><span>‚úì Aprovar</span></button>
        </div>`;
      setPill(card.querySelector("[data-status]"),st);
      lista.appendChild(card);
    });
  }
  $("contagem").textContent=`${totalItens} itens`;
  renderMods();
}

// üîπ Cards de totais
function renderMods(){
  const mods=$("mods");mods.innerHTML="";
  const statusCards=$("statusCards");statusCards.innerHTML="";
  let soma={Pix:0,Cart√£o:0,Boleto:0,Outros:0,Total:0};
  let somaStatus={Aprovado:0,Negado:0,Pendente:0};
  for(const emp of Object.keys(TITULOS)){
    (TITULOS[emp].__all||[]).forEach(t=>{
      const status=(t.status||"Pendente");
      const valor=Number(t.valor)||0;
      const meio=normalizeMeio(t.meio_pagamento);
      soma.Total+=valor;
      soma[meio]+=valor;
      if(somaStatus[status]!==undefined)somaStatus[status]+=valor;
    });
  }
  const cardStatus=(cls,label,val)=>`<div class="status-card ${cls}"><span>${label}</span><b>${BRL(val)}</b></div>`;
  statusCards.innerHTML+=cardStatus("aprovado","Aprovado",somaStatus.Aprovado);
  statusCards.innerHTML+=cardStatus("negado","Negado",somaStatus.Negado);
  statusCards.innerHTML+=cardStatus("pendente","Pendente",somaStatus.Pendente);
  const card=(cls,label,val)=>`<div class="mod ${cls}"><span>${label}</span><b>${BRL(val)}</b></div>`;
  mods.innerHTML+=card("pix","Pix",soma.Pix);
  mods.innerHTML+=card("cartao","Cart√£o",soma.Cart√£o);
  mods.innerHTML+=card("boleto","Boleto",soma.Boleto);
  mods.innerHTML+=card("total","Total",soma.Total);
}

// üîπ Sele√ß√£o em massa
function toggleSel(chk){
  const card=chk.closest(".titulo");
  const id=card.dataset.id,valor=Number(card.dataset.valor)||0;
  if(chk.checked)SELEC.push({id,valor});else SELEC=SELEC.filter(x=>x.id!==id);
  const total=SELEC.reduce((s,x)=>s+x.valor,0);
  if(SELEC.length){$("bubble").style.display="block";$("btnMassa").style.display="block";$("bubble").textContent="Total selecionado: "+BRL(total)}
  else{$("bubble").style.display="none";$("btnMassa").style.display="none"}
}
$("master").onchange=function(){document.querySelectorAll(".titulo .ck input").forEach(chk=>{chk.checked=this.checked;toggleSel(chk);});};

function setPill(el,status){
  el.className="pill";
  if(status==="Aprovado"){el.classList.add("ok");el.textContent="Aprovado"}
  else if(status==="Negado"){el.classList.add("warn");el.textContent="Negado"}
  else el.textContent=status;
}

// üîπ Atualiza filtros
async function refresh(){
  const filtro=$("filtroStatus").value;
  const filtroMeio=$("filtroMeio").value;
  const empresa=document.querySelector("#menuEmpresas input:checked").value;
  const ini=periodoInicio||iso(new Date());
  const fim=periodoFim||iso(new Date());
  await loadTitulos([empresa],ini,fim,filtro,filtroMeio);
  $("empresaSelecionada").textContent=empresa;
}

(function boot(){
  const hoje=new Date();
  flatpickr("#filtroPeriodo",{mode:"range",dateFormat:"d/m/Y",locale:"pt",defaultDate:[hoje,hoje],
    onClose:sel=>{if(sel.length===2){periodoInicio=iso(sel[0]);periodoFim=iso(sel[1]);refresh();}}
  });
  const M=$("menuEmpresas");
  EMP_DEFAULT.forEach((emp,i)=>{
    const lbl=document.createElement("label");
    lbl.innerHTML=`<input type="radio" name="empresaSel" value="${emp}" ${i===0?"checked":""}><span>${emp}</span>`;
    lbl.querySelector("input").onchange=()=>{refresh();M.style.display="none"};
    M.appendChild(lbl);
  });
  $("btnEmpresas").onclick=(e)=>{e.stopPropagation();M.style.display=M.style.display==="block"?"none":"block";};
  document.addEventListener("click",(e)=>{if(!M.contains(e.target)&&e.target.id!=="btnEmpresas"){M.style.display="none";}});
  $("filtroStatus").onchange=()=>refresh();
  $("filtroMeio").onchange=()=>refresh();
  refresh();
})();
</script>
</body>
</html>
