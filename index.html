<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>CAP - Grupo DV (F360)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
<style>
:root{
  --bg:#0b1220;--card:#0f172a;--ink:#e5f0ff;--muted:#a8b3c7;--line:#243043;
  --green:#16a34a;--red:#ef4444;--blue:#3b82f6;--gray:#6b7280;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink);font-size:15px}

header{position:sticky;top:0;z-index:20;background:#0f172a;
  border-bottom:1px solid var(--line);padding:14px;display:flex;flex-direction:column;gap:10px}
header h1{font-size:18px;margin:0;font-weight:800}

select,input{background:#0b1528;border:1px solid #22314b;color:var(--ink);
  padding:10px 14px;border-radius:10px;font-size:15px;width:100%}
.row-filtros{display:flex;gap:8px;width:100%}
.row-linha{display:flex;gap:8px;width:100%}

.container{padding:16px;max-width:1250px;margin:0 auto}

.status-cards {display:grid;gap:10px;margin:12px 0}
.status-card{border-radius:12px;padding:10px;font-weight:700;display:flex;justify-content:space-between;align-items:center;font-size:14px;color:#fff}
.status-card.aprovado{background:linear-gradient(180deg,#19c37d,#16a34a)}
.status-card.negado{background:linear-gradient(180deg,#fb6969,#ef4444)}
.status-card.pendente{background:linear-gradient(180deg,#60a5fa,#1d4ed8)}

.mods-card{margin:16px 0;background:#0f172a;border:1px solid var(--line);border-radius:18px;padding:16px}
.mods{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(min-width:768px){.mods{grid-template-columns:1fr 1fr 1fr}}
.mod{border-radius:16px;padding:14px;font-weight:700;display:flex;justify-content:space-between;align-items:center;font-size:16px;color:#fff}
.mod.pix{background:linear-gradient(180deg,#3b82f6,#1e40af)}
.mod.cartao{background:linear-gradient(180deg,#22c55e,#15803d)}
.mod.boleto{background:linear-gradient(180deg,#9ca3af,#374151)}
.mod.total{background:#0f172a;border:1px solid var(--line)}
</style>
</head>
<body>
<header>
  <h1>CAP - Grupo DV (F360)</h1>
  <div class="row-filtros">
    <select id="filtroStatus">
      <option value="Aberto" selected>Abertos</option>
      <option value="AbertoAVencer">À Vencer</option>
      <option value="AbertoVencidos">Vencidos</option>
      <option value="Todos">Todos</option>
    </select>
    <div style="position:relative;flex:1">
      <button class="btn" id="btnEmpresas"><span id="empresaSelecionada">MERCATTO DELÍCIA</span> ▼</button>
      <div id="menuEmpresas" class="menu"></div>
    </div>
  </div>
  <div class="row-linha">
    <input type="text" id="filtroPeriodo" placeholder="Selecione período" />
  </div>
</header>

<div class="container">
  <div id="statusCards" class="status-cards"></div>
  <div class="mods-card">
    <div style="font-weight:800;margin-bottom:8px;font-size:16px">Modalidades</div>
    <div id="mods" class="mods"></div>
  </div>
</div>

<script>
const F360_URL = "https://financas.f360.com.br/ParcelasDeTituloPublicAPI/ListarParcelasDeTitulos";
const f360Token = "ac0399fb-55dc-4c5c-bdde-0e3cf5943ac5"; // substitua pela sua chave F360

const EMPRESAS = {
  "DELICIA GOURMET": "44.734.130/0001-23",
  "MERCATTO DELÍCIA": "46.083.129/0001-01",
  "MERCATTO KIDS": "51.650.994/0001-22",
  "PADARIA DELÍCIA": "14.965.342/0001-50",
  "VILLA GOURMET BARREIRAS": "43.936.783/0001-22",
  "VILLA GOURMET LEM": "41.113.553/0001-38"
};

let periodoInicio=null, periodoFim=null;

const $=id=>document.getElementById(id);
const BRL=n=>(isNaN(n)?0:n).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const iso = d => { const dt=new Date(d); dt.setMinutes(dt.getMinutes()-dt.getTimezoneOffset()); return dt.toISOString().slice(0,10); };

function normalizarStatusF360(status){
  if(!status) return "Pendente";
  if(status.includes("Aberto")) return "Pendente";
  if(status.includes("Liquidado")||status.includes("Baixado")) return "Aprovado";
  return status;
}
function normalizarMeio(meio){
  meio=(meio||"Outros").toLowerCase();
  if(meio.includes("pix")) return "Pix";
  if(meio.includes("cart")) return "Cartão";
  if(meio.includes("bol")) return "Boleto";
  return "Outros";
}

async function fetchEmpresa(cnpj,inicio,fim,status="Aberto"){
  try{
    const url=`${F360_URL}?pagina=1&tipo=Despesa&inicio=${inicio}&fim=${fim}&tipoDatas=Vencimento&status=${status}&empresas=${encodeURIComponent(cnpj)}`;
    const r=await fetch(url,{
      headers:{
        "Authorization":`Bearer ${f360Token}`,
        "Content-Type":"application/json"
      }
    });
    const d=await r.json();
    if(!d.Ok) return [];
    return (d.Result.Parcelas||[]).map(p=>({
      valor:p.ValorBruto||0,
      meio:normalizarMeio(p.MeioDePagamento),
      status:normalizarStatusF360(p.Status)
    }));
  }catch(e){console.error("Erro F360",e);return [];}
}

async function refresh(){
  const empresa=document.querySelector("#menuEmpresas input:checked")?.value||"MERCATTO DELÍCIA";
  const cnpj=EMPRESAS[empresa];
  $("empresaSelecionada").textContent=empresa;
  const filtro=$("filtroStatus").value;
  const ini=periodoInicio||iso(new Date());
  const fim=periodoFim||iso(new Date());
  const dados=await fetchEmpresa(cnpj,ini,fim,filtro);

  let soma={Pix:0,Cartão:0,Boleto:0,Outros:0,Total:0};
  let somaStatus={Aprovado:0,Negado:0,Pendente:0};

  dados.forEach(t=>{
    soma.Total+=t.valor;
    soma[t.meio]=(soma[t.meio]||0)+t.valor;
    somaStatus[t.status]=(somaStatus[t.status]||0)+t.valor;
  });

  const statusCards=$("statusCards");statusCards.innerHTML="";
  statusCards.innerHTML+=`<div class="status-card aprovado"><span>Aprovado</span><b>${BRL(somaStatus.Aprovado)}</b></div>`;
  statusCards.innerHTML+=`<div class="status-card negado"><span>Negado</span><b>${BRL(somaStatus.Negado)}</b></div>`;
  statusCards.innerHTML+=`<div class="status-card pendente"><span>Pendente</span><b>${BRL(somaStatus.Pendente)}</b></div>`;

  const mods=$("mods");mods.innerHTML="";
  mods.innerHTML+=`<div class="mod pix"><span>Pix</span><b>${BRL(soma.Pix)}</b></div>`;
  mods.innerHTML+=`<div class="mod cartao"><span>Cartão</span><b>${BRL(soma.Cartão)}</b></div>`;
  mods.innerHTML+=`<div class="mod boleto"><span>Boleto</span><b>${BRL(soma.Boleto)}</b></div>`;
  mods.innerHTML+=`<div class="mod total"><span>Total</span><b>${BRL(soma.Total)}</b></div>`;
}

(function boot(){
  // menu empresas
  const M=$("menuEmpresas");
  Object.keys(EMPRESAS).forEach((emp,i)=>{
    const lbl=document.createElement("label");
    lbl.innerHTML=`<input type="radio" name="empresaSel" value="${emp}" ${i===1?"checked":""}><span>${emp}</span>`;
    lbl.querySelector("input").onchange=()=>{refresh();M.style.display="none"};
    M.appendChild(lbl);
  });

  $("btnEmpresas").onclick=(e)=>{e.stopPropagation();M.style.display=M.style.display==="block"?"none":"block";};
  document.addEventListener("click",(e)=>{if(!M.contains(e.target)&&e.target.id!=="btnEmpresas"){M.style.display="none";}});

  $("filtroStatus").onchange=()=>refresh();

  flatpickr("#filtroPeriodo",{
    mode:"range",dateFormat:"d/m/Y",locale:"pt",
    onClose:sel=>{
      if(sel.length===2){
        periodoInicio=iso(sel[0]);
        periodoFim=iso(sel[1]);
        refresh();
      }
    }
  });

  refresh();
})();
</script>
</body>
</html>
