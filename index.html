<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>CAP - F360</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
<style>
:root{
  --bg:#0b1220;--card:#0f172a;--ink:#e5f0ff;--muted:#a8b3c7;--line:#243043;
  --teal:#06b6d4;--blue:#4f46e5;--green:#16a34a;--red:#ef4444;--amber:#f59e0b;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink);font-size:15px}
header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#0f172a,#0b1220);
  border-bottom:1px solid var(--line);padding:14px;display:flex;flex-direction:column;gap:10px}
header h1{font-size:18px;margin:0;font-weight:800}
.controls{width:100%;display:flex;flex-direction:column;gap:8px}
.row-filtros{display:flex;gap:8px;width:100%}
.row-linha{display:flex;gap:8px;width:100%}
select,input{background:#0b1528;border:1px solid #22314b;color:var(--ink);
  padding:10px 14px;border-radius:10px;font-size:15px;width:100%}
.btn{border:1px solid #2a3955;background:#0b1528;color:var(--ink);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;font-size:15px;width:100%}
#overlay{position:fixed;inset:0;background:rgba(3,7,18,.55);display:none;align-items:center;justify-content:center;z-index:100}
.spinner{width:56px;height:56px;border:6px solid var(--teal);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.container{padding:16px;max-width:1250px;margin:0 auto}
.status-cards {display:grid;grid-template-columns:1fr;gap:10px;margin:12px 0;}
.status-card {border-radius:12px;padding:10px;font-weight:700;display:flex;justify-content:space-between;align-items:center;color:#fff;font-size:14px}
.status-card.aprovado {background:linear-gradient(180deg,#19c37d,#16a34a);}
.status-card.negado {background:linear-gradient(180deg,#fb6969,#ef4444);}
.status-card.pendente {background:linear-gradient(180deg,#60a5fa,#1d4ed8);}
.mods-card{margin:16px 0;background:#0f172a;border:1px solid var(--line);border-radius:18px;padding:16px}
.mods {display:grid;grid-template-columns:1fr 1fr;gap:12px;}
@media(min-width:1024px){.mods{grid-template-columns:1fr 1fr 1fr;}}
.mod{border-radius:16px;padding:14px;font-weight:700;display:flex;justify-content:space-between;align-items:center;color:#fff;font-size:16px}
.mod.total{background:#0f172a;border:1px solid var(--line)}
.mod.pix{background:linear-gradient(180deg,#3b82f6,#1e40af);}
.mod.cartao{background:linear-gradient(180deg,#22c55e,#15803d);}
.mod.boleto{background:linear-gradient(180deg,#9ca3af,#374151);}
.lista{display:grid;gap:14px;margin-top:14px}
.titulo{background:linear-gradient(180deg,#101a2f,#0f172a);border:1px solid var(--line);
  border-radius:18px;padding:12px;display:grid;gap:10px;position:relative}
.row{display:flex;gap:10px;flex-wrap:wrap;font-size:14px;color:var(--muted)}
.row b{color:var(--ink)}
.pill{padding:6px 12px;border-radius:999px;border:1px solid #2a3955;background:#0b1528;font-size:13px;font-weight:800;
  position:absolute;top:8px;right:8px}
.pill.ok{border-color:#155e32;color:#b6f3c5;background:#0e2a1b}
.pill.warn{border-color:#7a1e1e;color:#ffb4b4;background:#2a0e0e}
.actions{display:flex;gap:6px;flex-wrap:wrap}
.mini{flex:1;padding:8px;border-radius:12px;font-weight:700;cursor:pointer;font-size:14px;text-align:center}
.mini.aprovar{background:linear-gradient(180deg,#19c37d,#16a34a)}
.mini.negar{background:linear-gradient(180deg,#fb6969,#ef4444)}
.menu{position:absolute;top:100%;left:0;background:#0f172a;border:1px solid var(--line);border-radius:14px;padding:14px;display:none;z-index:30}
.menu label{display:flex;align-items:center;gap:8px;color:var(--ink);cursor:pointer;margin-bottom:6px}
</style>
</head>
<body>
<header>
  <h1>CAP - Grupo DV (F360)</h1>
  <div class="controls">
    <div class="row-filtros">
      <select id="filtroStatus">
        <option value="Aberto" selected>Abertos</option>
        <option value="AbertoAVencer">À Vencer</option>
        <option value="AbertoVencidos">Vencidos</option>
        <option value="Todos">Todos</option>
      </select>
    </div>
    <div class="row-linha">
      <input type="text" id="filtroPeriodo" placeholder="Selecione período" />
      <div style="position:relative;flex:1">
        <button class="btn" id="btnEmpresas"><span id="empresaSelecionada">DELICIA GOURMET</span> ▼</button>
        <div id="menuEmpresas" class="menu"></div>
      </div>
    </div>
  </div>
</header>

<div id="overlay"><div class="spinner"></div></div>
<div class="container">
  <div id="statusCards" class="status-cards"></div>
  <div class="mods-card">
    <div style="font-weight:800;margin-bottom:8px;font-size:16px">Modalidades</div>
    <div id="mods" class="mods"></div>
  </div>
  <div id="lista" class="lista"></div>
</div>

<script>
const F360_URL = "https://financas.f360.com.br/ParcelasDeTituloPublicAPI/ListarParcelasDeTitulos";
const f360Token = "ac0399fb-55dc-4c5c-bdde-0e3cf5943ac5"; // chave da API F360

const EMPRESAS = {
  "DELICIA GOURMET": "44.734.130/0001-23",
  "MERCATTO DELÍCIA": "46.083.129/0001-01",
  "MERCATTO KIDS": "51.650.994/0001-22",
  "PADARIA DELÍCIA": "14.965.342/0001-50",
  "VILLA GOURMET BARREIRAS": "43.936.783/0001-22",
  "VILLA GOURMET LEM": "41.113.553/0001-38"
};

const $=id=>document.getElementById(id);
const BRL=n=>(isNaN(n)?0:n).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const iso=d=>{const dt=new Date(d);dt.setMinutes(dt.getMinutes()-dt.getTimezoneOffset());return dt.toISOString().slice(0,10);};

async function fetchEmpresa(cnpj,inicio,fim,status="Aberto"){
  try{
    const url=`${F360_URL}?pagina=1&tipo=Despesa&inicio=${inicio}&fim=${fim}&tipoDatas=Vencimento&status=${status}&empresas=${encodeURIComponent(cnpj)}`;
    const r=await fetch(url,{
      headers:{
        "Authorization":`Bearer ${f360Token}`,
        "Content-Type":"application/json"
      }
    });
    const d=await r.json();
    if(!d.Ok) return [];
    return (d.Result.Parcelas||[]).map((p,i)=>({
      id:p.ParcelaId,
      fornecedor:p.DadosDoTitulo.ClienteFornecedor?.Nome||"Fornecedor não informado",
      vencimento:p.Vencimento,
      meio_pagamento:p.MeioDePagamento||"Outros",
      valor:p.ValorBruto||0,
      status:p.Status.includes("Aberto")?"Pendente":p.Status,
      observacao:p.DadosDoTitulo.Observacao||""
    }));
  }catch(e){console.error("Erro ao buscar no F360",e);return [];}
}

function renderStatusMods(parcelas){
  let soma={Pix:0,Cartão:0,Boleto:0,Outros:0,Total:0};
  let somaStatus={Aprovado:0,Negado:0,Pendente:0};
  parcelas.forEach(t=>{
    const meio=(t.meio_pagamento||"").toLowerCase().includes("pix")?"Pix":
                (t.meio_pagamento||"").toLowerCase().includes("cart")?"Cartão":
                (t.meio_pagamento||"").toLowerCase().includes("bol")?"Boleto":"Outros";
    soma[meio]+=t.valor; soma.Total+=t.valor;
    somaStatus[t.status] = (somaStatus[t.status]||0)+t.valor;
  });
  $("statusCards").innerHTML=`
    <div class="status-card aprovado"><span>Aprovado</span><b>${BRL(somaStatus.Aprovado||0)}</b></div>
    <div class="status-card negado"><span>Negado</span><b>${BRL(somaStatus.Negado||0)}</b></div>
    <div class="status-card pendente"><span>Pendente</span><b>${BRL(somaStatus.Pendente||0)}</b></div>`;
  $("mods").innerHTML=`
    <div class="mod pix"><span>Pix</span><b>${BRL(soma.Pix)}</b></div>
    <div class="mod cartao"><span>Cartão</span><b>${BRL(soma["Cartão"])}</b></div>
    <div class="mod boleto"><span>Boleto</span><b>${BRL(soma.Boleto)}</b></div>
    <div class="mod total"><span>Total</span><b>${BRL(soma.Total)}</b></div>`;
}

function renderLista(parcelas){
  const lista=$("lista"); lista.innerHTML="";
  parcelas.forEach(t=>{
    const card=document.createElement("div");
    card.className="titulo";
    card.innerHTML=`
      <div class="row"><b>${t.fornecedor}</b></div>
      <div class="row">Venc: <b>${iso(t.vencimento).split("-").reverse().join("/")}</b> • Meio: <b>${t.meio_pagamento}</b></div>
      <div class="row">Valor: <b>${BRL(t.valor)}</b></div>
      ${t.observacao?`<div class="row">Obs: ${t.observacao}</div>`:""}
      <span class="pill">${t.status}</span>
      <div class="actions">
        <button class="mini negar" onclick="this.closest('.titulo').querySelector('.pill').textContent='Negado'">Negar</button>
        <button class="mini aprovar" onclick="this.closest('.titulo').querySelector('.pill').textContent='Aprovado'">Aprovar</button>
      </div>`;
    lista.appendChild(card);
  });
}

async function refresh(){
  $("overlay").style.display="flex";
  const empresaNome=document.querySelector("#menuEmpresas input:checked").value;
  const cnpj=EMPRESAS[empresaNome];
  const status=$("filtroStatus").value;
  const ini=iso(periodoInicio||new Date());
  const fim=iso(periodoFim||new Date());
  const parcelas=await fetchEmpresa(cnpj,ini,fim,status);
  renderStatusMods(parcelas);
  renderLista(parcelas);
  $("empresaSelecionada").textContent=empresaNome;
  $("overlay").style.display="none";
}

// Período global
let periodoInicio=new Date(),periodoFim=new Date();

(function boot(){
  flatpickr("#filtroPeriodo",{mode:"range",dateFormat:"d/m/Y",locale:"pt",defaultDate:[new Date(),new Date()],
    onClose:sel=>{if(sel.length===2){periodoInicio=sel[0];periodoFim=sel[1];refresh();}}});
  const M=$("menuEmpresas");
  Object.keys(EMPRESAS).forEach((emp,i)=>{
    const lbl=document.createElement("label");
    lbl.innerHTML=`<input type="radio" name="empresaSel" value="${emp}" ${i===0?"checked":""}> <span>${emp}</span>`;
    lbl.querySelector("input").onchange=()=>{refresh();M.style.display="none"};
    M.appendChild(lbl);
  });
  $("btnEmpresas").onclick=e=>{e.stopPropagation();M.style.display=M.style.display==="block"?"none":"block";};
  document.addEventListener("click",e=>{if(!M.contains(e.target)&&e.target.id!=="btnEmpresas"){M.style.display="none";}});
  $("filtroStatus").onchange=()=>refresh();
  refresh();
})();
</script>
</body>
</html>
